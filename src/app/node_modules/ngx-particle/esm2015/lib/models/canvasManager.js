import { ParticlesManager } from './particlesManager';
import { hexToRgb } from './utils';
export class CanvasManager {
    constructor(_canvasParams, _params, _tmpParams) {
        this._canvasParams = _canvasParams;
        this._params = _params;
        this._tmpParams = _tmpParams;
        this._onWindowResize = this._onWindowResize.bind(this);
        this._retinaInit();
        this._canvasSize();
        this.particlesManager = new ParticlesManager(this._canvasParams, this._params, this._tmpParams);
        this.particlesManager.particlesCreate();
        this._densityAutoParticles();
        let { particles } = this._params;
        particles.line_linked.color_rgb_line = hexToRgb(particles.line_linked.color);
    }
    cancelAnimation() {
        if (!this._tmpParams.drawAnimFrame) {
            return;
        }
        cancelAnimationFrame(this._tmpParams.drawAnimFrame);
        this._tmpParams.drawAnimFrame = null;
    }
    draw() {
        let { particles } = this._params;
        if (particles.shape.type == 'image') {
            if (this._tmpParams.img_type == 'svg') {
                if (this._tmpParams.count_svg >= particles.number.value) {
                    this.particlesManager.particlesDraw();
                    if (!particles.move.enable) {
                        cancelAnimationFrame(this._tmpParams.drawAnimFrame);
                    }
                    else {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
                else {
                    if (!this._tmpParams.img_error) {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
            }
            else {
                if (this._tmpParams.img_obj != undefined) {
                    this.particlesManager.particlesDraw();
                    if (!particles.move.enable) {
                        cancelAnimationFrame(this._tmpParams.drawAnimFrame);
                    }
                    else {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
                else {
                    if (!this._tmpParams.img_error) {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
            }
        }
        else {
            this.particlesManager.particlesDraw();
            if (!particles.move.enable) {
                cancelAnimationFrame(this._tmpParams.drawAnimFrame);
            }
            else {
                this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
            }
        }
    }
    _densityAutoParticles() {
        let { particles } = this._params;
        if (particles.number.density.enable) {
            let area = this._canvasParams.el.width * this._canvasParams.el.height / 1000;
            if (this._tmpParams.retina) {
                area = area / (this._canvasParams.pxratio * 2);
            }
            let nb_particles = area * particles.number.value / particles.number.density.value_area;
            let missing_particles = particles.array.length - nb_particles;
            if (missing_particles < 0) {
                this.particlesManager.pushParticles(Math.abs(missing_particles));
            }
            else {
                this.particlesManager.removeParticles(missing_particles);
            }
        }
    }
    _retinaInit() {
        if (this._params.retina_detect && window.devicePixelRatio > 1) {
            this._canvasParams.pxratio = window.devicePixelRatio;
            this._tmpParams.retina = true;
            this._canvasParams.width = this._canvasParams.el.offsetWidth * this._canvasParams.pxratio;
            this._canvasParams.height = this._canvasParams.el.offsetHeight * this._canvasParams.pxratio;
            this._params.particles.size.value = this._tmpParams.obj.size_value * this._canvasParams.pxratio;
            this._params.particles.size.anim.speed = this._tmpParams.obj.size_anim_speed * this._canvasParams.pxratio;
            this._params.particles.move.speed = this._tmpParams.obj.move_speed * this._canvasParams.pxratio;
            this._params.particles.line_linked.distance = this._tmpParams.obj.line_linked_distance * this._canvasParams.pxratio;
            this._params.interactivity.modes.grab.distance = this._tmpParams.obj.mode_grab_distance * this._canvasParams.pxratio;
            this._params.interactivity.modes.bubble.distance = this._tmpParams.obj.mode_bubble_distance * this._canvasParams.pxratio;
            this._params.particles.line_linked.width = this._tmpParams.obj.line_linked_width * this._canvasParams.pxratio;
            this._params.interactivity.modes.bubble.size = this._tmpParams.obj.mode_bubble_size * this._canvasParams.pxratio;
            this._params.interactivity.modes.repulse.distance = this._tmpParams.obj.mode_repulse_distance * this._canvasParams.pxratio;
        }
        else {
            this._canvasParams.pxratio = 1;
            this._tmpParams.retina = false;
        }
    }
    _canvasClear() {
        this._canvasParams.ctx.clearRect(0, 0, this._canvasParams.width, this._canvasParams.height);
    }
    _canvasPaint() {
        this._canvasParams.ctx.fillRect(0, 0, this._canvasParams.width, this._canvasParams.height);
    }
    _canvasSize() {
        this._canvasParams.el.width = this._canvasParams.width;
        this._canvasParams.el.height = this._canvasParams.height;
        if (this._params && this._params.interactivity.events.resize) {
            window.addEventListener('resize', this._onWindowResize);
        }
    }
    _onWindowResize() {
        this._canvasParams.width = this._canvasParams.el.offsetWidth;
        this._canvasParams.height = this._canvasParams.el.offsetHeight;
        if (this._tmpParams.retina) {
            this._canvasParams.width *= this._canvasParams.pxratio;
            this._canvasParams.height *= this._canvasParams.pxratio;
        }
        this._canvasParams.el.width = this._canvasParams.width;
        this._canvasParams.el.height = this._canvasParams.height;
        if (!this._params.particles.move.enable) {
            this.particlesManager.particlesEmpty();
            this.particlesManager.particlesCreate();
            this.particlesManager.particlesDraw();
            this._densityAutoParticles();
        }
        this._densityAutoParticles();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wYXJ0aWNsZS8iLCJzb3VyY2VzIjpbImxpYi9tb2RlbHMvY2FudmFzTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV0RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5DLE1BQU0sT0FBTyxhQUFhO0lBR3RCLFlBQW9CLGFBQTRCLEVBQVUsT0FBZ0IsRUFBVSxVQUFzQjtRQUF0RixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUFVLFlBQU8sR0FBUCxPQUFPLENBQVM7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RHLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2hHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV4QyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUU3QixJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUNqQyxTQUFTLENBQUMsV0FBVyxDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqRixDQUFDO0lBRU0sZUFBZTtRQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUU7WUFDaEMsT0FBTztTQUNWO1FBQ0Qs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bXBvcnQgeyBQYXJ0aWNsZXNNYW5hZ2VyIH0gZnJvbSAnLi9wYXJ0aWNsZXNNYW5hZ2VyJztcclxuaW1wb3J0IHsgSUNhbnZhc1BhcmFtcywgSVBhcmFtcywgSVRtcFBhcmFtcyB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XHJcbmltcG9ydCB7IGhleFRvUmdiIH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ2FudmFzTWFuYWdlciB7XHJcbiAgICBwdWJsaWMgcGFydGljbGVzTWFuYWdlcjogUGFydGljbGVzTWFuYWdlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9jYW52YXNQYXJhbXM6IElDYW52YXNQYXJhbXMsIHByaXZhdGUgX3BhcmFtczogSVBhcmFtcywgcHJpdmF0ZSBfdG1wUGFyYW1zOiBJVG1wUGFyYW1zKSB7XHJcbiAgICAgICAgdGhpcy5fb25XaW5kb3dSZXNpemUgPSB0aGlzLl9vbldpbmRvd1Jlc2l6ZS5iaW5kKHRoaXMpO1xyXG5cclxuICAgICAgICB0aGlzLl9yZXRpbmFJbml0KCk7XHJcbiAgICAgICAgdGhpcy5fY2FudmFzU2l6ZSgpO1xyXG5cclxuICAgICAgICB0aGlzLnBhcnRpY2xlc01hbmFnZXIgPSBuZXcgUGFydGljbGVzTWFuYWdlcih0aGlzLl9jYW52YXNQYXJhbXMsIHRoaXMuX3BhcmFtcywgdGhpcy5fdG1wUGFyYW1zKTtcclxuICAgICAgICB0aGlzLnBhcnRpY2xlc01hbmFnZXIucGFydGljbGVzQ3JlYXRlKCk7XHJcblxyXG4gICAgICAgIHRoaXMuX2RlbnNpdHlBdXRvUGFydGljbGVzKCk7XHJcblxyXG4gICAgICAgIGxldCB7IHBhcnRpY2xlcyB9ID0gdGhpcy5fcGFyYW1zO1xyXG4gICAgICAgIHBhcnRpY2xlcy5saW5lX2xpbmtlZC5jb2xvcl9yZ2JfbGluZSA9IGhleFRvUmdiKHBhcnRpY2xlcy5saW5lX2xpbmtlZC5jb2xvcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNhbmNlbEFuaW1hdGlvbigpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUpO1xyXG4gICAgICAgIHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZHJhdygpOiB2b2lkIHtcclxuICAgICAgICBsZXQgeyBwYXJ0aWNsZXMgfSA9IHRoaXMuX3BhcmFtcztcclxuXHJcbiAgICAgICAgaWYgKHBhcnRpY2xlcy5zaGFwZS50eXBlID09ICdpbWFnZScpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3RtcFBhcmFtcy5pbWdfdHlwZSA9PSAnc3ZnJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3RtcFBhcmFtcy5jb3VudF9zdmcgPj0gcGFydGljbGVzLm51bWJlci52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5wYXJ0aWNsZXNEcmF3KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0aWNsZXMubW92ZS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZHJhdy5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdG1wUGFyYW1zLmltZ19lcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLmRyYXcuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3RtcFBhcmFtcy5pbWdfb2JqICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5wYXJ0aWNsZXNEcmF3KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJ0aWNsZXMubW92ZS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZHJhdy5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdG1wUGFyYW1zLmltZ19lcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLmRyYXcuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnBhcnRpY2xlc0RyYXcoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghcGFydGljbGVzLm1vdmUuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLmRyYXcuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZGVuc2l0eUF1dG9QYXJ0aWNsZXMoKTogdm9pZCB7XHJcbiAgICAgICAgbGV0IHsgcGFydGljbGVzIH0gPSB0aGlzLl9wYXJhbXM7XHJcblxyXG4gICAgICAgIGlmIChwYXJ0aWNsZXMubnVtYmVyLmRlbnNpdHkuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIGxldCBhcmVhOiBudW1iZXIgPSB0aGlzLl9jYW52YXNQYXJhbXMuZWwud2lkdGggKiB0aGlzLl9jYW52YXNQYXJhbXMuZWwuaGVpZ2h0IC8gMTAwMDtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLl90bXBQYXJhbXMucmV0aW5hKSB7XHJcbiAgICAgICAgICAgICAgICBhcmVhID0gYXJlYSAvICh0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbyAqIDIpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgbmJfcGFydGljbGVzOiBudW1iZXIgPSBhcmVhICogcGFydGljbGVzLm51bWJlci52YWx1ZSAvIHBhcnRpY2xlcy5udW1iZXIuZGVuc2l0eS52YWx1ZV9hcmVhO1xyXG5cclxuICAgICAgICAgICAgbGV0IG1pc3NpbmdfcGFydGljbGVzOiBudW1iZXIgPSBwYXJ0aWNsZXMuYXJyYXkubGVuZ3RoIC0gbmJfcGFydGljbGVzO1xyXG5cclxuICAgICAgICAgICAgaWYgKG1pc3NpbmdfcGFydGljbGVzIDwgMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnB1c2hQYXJ0aWNsZXMoTWF0aC5hYnMobWlzc2luZ19wYXJ0aWNsZXMpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5yZW1vdmVQYXJ0aWNsZXMobWlzc2luZ19wYXJ0aWNsZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3JldGluYUluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3BhcmFtcy5yZXRpbmFfZGV0ZWN0ICYmIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvID4gMSkge1xyXG4gICAgICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbyA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLl90bXBQYXJhbXMucmV0aW5hID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy53aWR0aCA9IHRoaXMuX2NhbnZhc1BhcmFtcy5lbC5vZmZzZXRXaWR0aCAqIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuaGVpZ2h0ID0gdGhpcy5fY2FudmFzUGFyYW1zLmVsLm9mZnNldEhlaWdodCAqIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5zaXplLnZhbHVlID0gdGhpcy5fdG1wUGFyYW1zLm9iai5zaXplX3ZhbHVlICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMuc2l6ZS5hbmltLnNwZWVkID0gdGhpcy5fdG1wUGFyYW1zLm9iai5zaXplX2FuaW1fc3BlZWQgKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5tb3ZlLnNwZWVkID0gdGhpcy5fdG1wUGFyYW1zLm9iai5tb3ZlX3NwZWVkICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMubGluZV9saW5rZWQuZGlzdGFuY2UgPSB0aGlzLl90bXBQYXJhbXMub2JqLmxpbmVfbGlua2VkX2Rpc3RhbmNlICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmdyYWIuZGlzdGFuY2UgPSB0aGlzLl90bXBQYXJhbXMub2JqLm1vZGVfZ3JhYl9kaXN0YW5jZSAqIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5tb2Rlcy5idWJibGUuZGlzdGFuY2UgPSB0aGlzLl90bXBQYXJhbXMub2JqLm1vZGVfYnViYmxlX2Rpc3RhbmNlICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMubGluZV9saW5rZWQud2lkdGggPSB0aGlzLl90bXBQYXJhbXMub2JqLmxpbmVfbGlua2VkX3dpZHRoICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5zaXplID0gdGhpcy5fdG1wUGFyYW1zLm9iai5tb2RlX2J1YmJsZV9zaXplICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLnJlcHVsc2UuZGlzdGFuY2UgPSB0aGlzLl90bXBQYXJhbXMub2JqLm1vZGVfcmVwdWxzZV9kaXN0YW5jZSAqIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbyA9IDE7XHJcbiAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5yZXRpbmEgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY2FudmFzQ2xlYXIoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLmN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy5fY2FudmFzUGFyYW1zLndpZHRoLCB0aGlzLl9jYW52YXNQYXJhbXMuaGVpZ2h0KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jYW52YXNQYWludCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuY3R4LmZpbGxSZWN0KDAsIDAsIHRoaXMuX2NhbnZhc1BhcmFtcy53aWR0aCwgdGhpcy5fY2FudmFzUGFyYW1zLmhlaWdodCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY2FudmFzU2l6ZSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuZWwud2lkdGggPSB0aGlzLl9jYW52YXNQYXJhbXMud2lkdGg7XHJcbiAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLmVsLmhlaWdodCA9IHRoaXMuX2NhbnZhc1BhcmFtcy5oZWlnaHQ7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl9wYXJhbXMgJiYgdGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkuZXZlbnRzLnJlc2l6ZSkge1xyXG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5fb25XaW5kb3dSZXNpemUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9vbldpbmRvd1Jlc2l6ZSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMud2lkdGggPSB0aGlzLl9jYW52YXNQYXJhbXMuZWwub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLmhlaWdodCA9IHRoaXMuX2NhbnZhc1BhcmFtcy5lbC5vZmZzZXRIZWlnaHQ7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl90bXBQYXJhbXMucmV0aW5hKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy53aWR0aCAqPSB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLmhlaWdodCAqPSB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5lbC53aWR0aCA9IHRoaXMuX2NhbnZhc1BhcmFtcy53aWR0aDtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuZWwuaGVpZ2h0ID0gdGhpcy5fY2FudmFzUGFyYW1zLmhlaWdodDtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLl9wYXJhbXMucGFydGljbGVzLm1vdmUuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5wYXJ0aWNsZXNFbXB0eSgpO1xyXG4gICAgICAgICAgICB0aGlzLnBhcnRpY2xlc01hbmFnZXIucGFydGljbGVzQ3JlYXRlKCk7XHJcbiAgICAgICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5wYXJ0aWNsZXNEcmF3KCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2RlbnNpdHlBdXRvUGFydGljbGVzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9kZW5zaXR5QXV0b1BhcnRpY2xlcygpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==