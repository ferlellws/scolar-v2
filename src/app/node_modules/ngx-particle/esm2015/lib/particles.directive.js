import { __decorate, __metadata } from "tslib";
import { Directive, ElementRef, AfterViewInit, HostListener, Input, OnDestroy } from "@angular/core";
import { CanvasManager, getDefaultParams, isInArray, deepExtend, loadImg } from './models';
let ParticlesDirective = class ParticlesDirective {
    constructor(el) {
        this.el = el;
        this._tmpParams = {};
    }
    set params(value) {
        let defaultParams = getDefaultParams();
        this._params = deepExtend(defaultParams, value);
    }
    ngOnDestroy() {
        if (!this._canvasManager) {
            return;
        }
        this._canvasManager.cancelAnimation();
    }
    ngAfterViewInit() {
        this._canvasParams = {
            el: this.el.nativeElement,
            ctx: this.el.nativeElement.getContext('2d'),
            width: this.el.nativeElement.offsetWidth,
            height: this.el.nativeElement.offsetHeight
        };
        this._tmpParams.obj = {
            size_value: this._params.particles.size.value,
            size_anim_speed: this._params.particles.size.anim.speed,
            move_speed: this._params.particles.move.speed,
            line_linked_distance: this._params.particles.line_linked.distance,
            line_linked_width: this._params.particles.line_linked.width,
            mode_grab_distance: this._params.interactivity.modes.grab.distance,
            mode_bubble_distance: this._params.interactivity.modes.bubble.distance,
            mode_bubble_size: this._params.interactivity.modes.bubble.size,
            mode_repulse_distance: this._params.interactivity.modes.repulse.distance
        };
        this._params.interactivity.el = (this._params.interactivity.detect_on == 'window') ? window : this._canvasParams.el;
        if (isInArray('image', this._params.particles.shape.type)) {
            this._tmpParams.img_type = this._params.particles.shape.image.src.substr(this._params.particles.shape.image.src.length - 3);
            loadImg(this._params, this._tmpParams);
        }
        this._canvasManager = new CanvasManager(this._canvasParams, this._params, this._tmpParams);
        this._canvasManager.draw();
    }
    /**
     * Mouse move event
     * @param event
     */
    onMouseMove(event) {
        let { interactivity } = this._params;
        if (interactivity.events.onhover.enable ||
            interactivity.events.onclick.enable) {
            let pos;
            if (interactivity.el == window) {
                pos = {
                    x: event.clientX,
                    y: event.clientY
                };
            }
            else {
                pos = {
                    x: event.offsetX || event.clientX,
                    y: event.offsetY || event.clientY
                };
            }
            interactivity.mouse.pos_x = pos.x;
            interactivity.mouse.pos_y = pos.y;
            if (this._tmpParams.retina) {
                interactivity.mouse.pos_x *= this._canvasParams.pxratio;
                interactivity.mouse.pos_y *= this._canvasParams.pxratio;
            }
            interactivity.status = 'mousemove';
        }
    }
    /**
     * Mouse leave event
     */
    onMouseLeave() {
        let { interactivity } = this._params;
        if (interactivity.events.onhover.enable ||
            interactivity.events.onclick.enable) {
            interactivity.mouse.pos_x = null;
            interactivity.mouse.pos_y = null;
            interactivity.status = 'mouseleave';
        }
    }
    /**
     * Click event
     */
    onClick() {
        let { interactivity, particles } = this._params;
        if (interactivity.events.onclick.enable) {
            interactivity.mouse.click_pos_x = interactivity.mouse.pos_x;
            interactivity.mouse.click_pos_y = interactivity.mouse.pos_y;
            interactivity.mouse.click_time = new Date().getTime();
            switch (interactivity.events.onclick.mode) {
                case 'push':
                    if (particles.move.enable) {
                        this._canvasManager.particlesManager.pushParticles(interactivity.modes.push.particles_nb, interactivity.mouse);
                    }
                    else {
                        if (interactivity.modes.push.particles_nb == 1) {
                            this._canvasManager.particlesManager.pushParticles(interactivity.modes.push.particles_nb, interactivity.mouse);
                        }
                        else if (interactivity.modes.push.particles_nb > 1) {
                            this._canvasManager.particlesManager.pushParticles(interactivity.modes.push.particles_nb);
                        }
                    }
                    break;
                case 'remove':
                    this._canvasManager.particlesManager.removeParticles(interactivity.modes.remove.particles_nb);
                    break;
                case 'bubble':
                    this._tmpParams.bubble_clicking = true;
                    break;
                case 'repulse':
                    this._tmpParams.repulse_clicking = true;
                    this._tmpParams.repulse_count = 0;
                    this._tmpParams.repulse_finish = false;
                    setTimeout(() => {
                        this._tmpParams.repulse_clicking = false;
                    }, interactivity.modes.repulse.duration * 1000);
                    break;
            }
        }
    }
};
ParticlesDirective.ctorParameters = () => [
    { type: ElementRef }
];
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], ParticlesDirective.prototype, "params", null);
__decorate([
    HostListener('mousemove', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], ParticlesDirective.prototype, "onMouseMove", null);
__decorate([
    HostListener('mouseleave'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], ParticlesDirective.prototype, "onMouseLeave", null);
__decorate([
    HostListener('click'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], ParticlesDirective.prototype, "onClick", null);
ParticlesDirective = __decorate([
    Directive({
        selector: '[d-particles]'
    }),
    __metadata("design:paramtypes", [ElementRef])
], ParticlesDirective);
export { ParticlesDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGljbGVzLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wYXJ0aWNsZS8iLCJzb3VyY2VzIjpbImxpYi9wYXJ0aWNsZXMuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckcsT0FBTyxFQUFFLGFBQWEsRUFBc0MsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFLL0gsSUFBYSxrQkFBa0IsR0FBL0IsTUFBYSxrQkFBa0I7SUFNM0IsWUFBb0IsRUFBYztRQUFkLE9BQUUsR0FBRixFQUFFLENBQVk7UUFJMUIsZUFBVSxHQUFlLEVBQUUsQ0FBQztJQUpFLENBQUM7SUFMOUIsSUFBSSxNQUFNLENBQUMsS0FBYztRQUM5QixJQUFJLGFBQWEsR0FBWSxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2hELElBQUksQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBU0QsV0FBVztRQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3RCLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDMUMsQ0FBQztJQUVELGVBQWU7UUFDWCxJQUFJLENBQUMsYUFBYSxHQUFHO1lBQ2pCLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWE7WUFDekIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7WUFDM0MsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLFdBQVc7WUFDeEMsTUFBTSxFQUFFLElBQUksQ0FBQyxF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QUM7b0JBQ3ZDLE1BQU07Z0JBRVYsS0FBSyxTQUFTO29CQUNWLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO29CQUN4QyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7b0JBQ2xDLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztvQkFDdkMsVUFBVSxDQUFDLEdBQUcsRUFBRTt3QkFDWixJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztvQkFDN0MsQ0FBQyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQztvQkFDaEQsTUFBTTthQUNiO1NBQ0o7SUFDTCxDQUFDO0NBQ0osQ0FBQTs7WUE5STJCLFVBQVU7O0FBTHpCO0lBQVIsS0FBSyxFQUFFOzs7Z0RBR1A7QUFtRHNDO0lBQXRDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7OztxREFpQ3JDO0FBSzJCO0lBQTNCLFlBQVksQ0FBQyxZQUFZLENBQUM7Ozs7c0RBVTFCO0FBS3NCO0lBQXRCLFlBQVksQ0FBQyxPQUFPLENBQUM7Ozs7aURBdUNyQjtBQW5KUSxrQkFBa0I7SUFIOUIsU0FBUyxDQUFDO1FBQ1AsUUFBUSxFQUFFLGVBQWU7S0FDNUIsQ0FBQztxQ0FPMEIsVUFBVTtHQU56QixrQkFBa0IsQ0FvSjlCO1NBcEpZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgQWZ0ZXJWaWV3SW5pdCwgSG9zdExpc3RlbmVyLCBJbnB1dCwgT25EZXN0cm95IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQ2FudmFzTWFuYWdlciwgSUNhbnZhc1BhcmFtcywgSVBhcmFtcywgSVRtcFBhcmFtcywgZ2V0RGVmYXVsdFBhcmFtcywgaXNJbkFycmF5LCBkZWVwRXh0ZW5kLCBsb2FkSW1nIH0gZnJvbSAnLi9tb2RlbHMnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tkLXBhcnRpY2xlc10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQYXJ0aWNsZXNEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kgIHtcclxuICAgIEBJbnB1dCgpIHNldCBwYXJhbXModmFsdWU6IElQYXJhbXMpIHtcclxuICAgICAgICBsZXQgZGVmYXVsdFBhcmFtczogSVBhcmFtcyA9IGdldERlZmF1bHRQYXJhbXMoKTtcclxuICAgICAgICB0aGlzLl9wYXJhbXMgPSBkZWVwRXh0ZW5kKGRlZmF1bHRQYXJhbXMsIHZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsOiBFbGVtZW50UmVmKSB7IH1cclxuXHJcbiAgICBwcml2YXRlIF9jYW52YXNQYXJhbXM6IElDYW52YXNQYXJhbXM7XHJcbiAgICBwcml2YXRlIF9wYXJhbXM6IElQYXJhbXM7XHJcbiAgICBwcml2YXRlIF90bXBQYXJhbXM6IElUbXBQYXJhbXMgPSB7fTtcclxuICAgIHByaXZhdGUgX2NhbnZhc01hbmFnZXI6IENhbnZhc01hbmFnZXI7XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9jYW52YXNNYW5hZ2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fY2FudmFzTWFuYWdlci5jYW5jZWxBbmltYXRpb24oKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zID0ge1xyXG4gICAgICAgICAgICBlbDogdGhpcy5lbC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICBjdHg6IHRoaXMuZWwubmF0aXZlRWxlbWVudC5nZXRDb250ZXh0KCcyZCcpLFxyXG4gICAgICAgICAgICB3aWR0aDogdGhpcy5lbC5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZWwubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLl90bXBQYXJhbXMub2JqID0ge1xyXG4gICAgICAgICAgICBzaXplX3ZhbHVlOiB0aGlzLl9wYXJhbXMucGFydGljbGVzLnNpemUudmFsdWUsXHJcbiAgICAgICAgICAgIHNpemVfYW5pbV9zcGVlZDogdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5zaXplLmFuaW0uc3BlZWQsXHJcbiAgICAgICAgICAgIG1vdmVfc3BlZWQ6IHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMubW92ZS5zcGVlZCxcclxuICAgICAgICAgICAgbGluZV9saW5rZWRfZGlzdGFuY2U6IHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMubGluZV9saW5rZWQuZGlzdGFuY2UsXHJcbiAgICAgICAgICAgIGxpbmVfbGlua2VkX3dpZHRoOiB0aGlzLl9wYXJhbXMucGFydGljbGVzLmxpbmVfbGlua2VkLndpZHRoLFxyXG4gICAgICAgICAgICBtb2RlX2dyYWJfZGlzdGFuY2U6IHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmdyYWIuZGlzdGFuY2UsXHJcbiAgICAgICAgICAgIG1vZGVfYnViYmxlX2Rpc3RhbmNlOiB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5tb2Rlcy5idWJibGUuZGlzdGFuY2UsXHJcbiAgICAgICAgICAgIG1vZGVfYnViYmxlX3NpemU6IHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5zaXplLFxyXG4gICAgICAgICAgICBtb2RlX3JlcHVsc2VfZGlzdGFuY2U6IHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLnJlcHVsc2UuZGlzdGFuY2VcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5lbCA9ICh0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5kZXRlY3Rfb24gPT0gJ3dpbmRvdycpID8gd2luZG93IDogdGhpcy5fY2FudmFzUGFyYW1zLmVsO1xyXG5cclxuICAgICAgICBpZiAoaXNJbkFycmF5KCdpbWFnZScsIHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMuc2hhcGUudHlwZSkpIHtcclxuICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLmltZ190eXBlID0gdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5zaGFwZS5pbWFnZS5zcmMuc3Vic3RyKHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMuc2hhcGUuaW1hZ2Uuc3JjLmxlbmd0aCAtIDMpO1xyXG4gICAgICAgICAgICBsb2FkSW1nKHRoaXMuX3BhcmFtcywgdGhpcy5fdG1wUGFyYW1zKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2NhbnZhc01hbmFnZXIgPSBuZXcgQ2FudmFzTWFuYWdlcih0aGlzLl9jYW52YXNQYXJhbXMsIHRoaXMuX3BhcmFtcywgdGhpcy5fdG1wUGFyYW1zKTtcclxuICAgICAgICB0aGlzLl9jYW52YXNNYW5hZ2VyLmRyYXcoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIE1vdXNlIG1vdmUgZXZlbnRcclxuICAgICAqIEBwYXJhbSBldmVudFxyXG4gICAgICovXHJcbiAgICBASG9zdExpc3RlbmVyKCdtb3VzZW1vdmUnLCBbJyRldmVudCddKSBvbk1vdXNlTW92ZShldmVudCkge1xyXG4gICAgICAgIGxldCB7IGludGVyYWN0aXZpdHkgfSA9IHRoaXMuX3BhcmFtcztcclxuXHJcbiAgICAgICAgaWYgKGludGVyYWN0aXZpdHkuZXZlbnRzLm9uaG92ZXIuZW5hYmxlIHx8XHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkuZXZlbnRzLm9uY2xpY2suZW5hYmxlKSB7XHJcblxyXG4gICAgICAgICAgICBsZXQgcG9zOiB7XHJcbiAgICAgICAgICAgICAgICB4OiBudW1iZXI7XHJcbiAgICAgICAgICAgICAgICB5OiBudW1iZXI7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBpZiAoaW50ZXJhY3Rpdml0eS5lbCA9PSB3aW5kb3cpIHtcclxuICAgICAgICAgICAgICAgIHBvcyA9IHtcclxuICAgICAgICAgICAgICAgICAgICB4OiBldmVudC5jbGllbnRYLFxyXG4gICAgICAgICAgICAgICAgICAgIHk6IGV2ZW50LmNsaWVudFlcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBwb3MgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgeDogZXZlbnQub2Zmc2V0WCB8fCBldmVudC5jbGllbnRYLFxyXG4gICAgICAgICAgICAgICAgICAgIHk6IGV2ZW50Lm9mZnNldFkgfHwgZXZlbnQuY2xpZW50WVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NfeCA9IHBvcy54O1xyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5Lm1vdXNlLnBvc195ID0gcG9zLnk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5fdG1wUGFyYW1zLnJldGluYSkge1xyXG4gICAgICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NfeCAqPSB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UucG9zX3kgKj0gdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkuc3RhdHVzID0gJ21vdXNlbW92ZSc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTW91c2UgbGVhdmUgZXZlbnRcclxuICAgICAqL1xyXG4gICAgQEhvc3RMaXN0ZW5lcignbW91c2VsZWF2ZScpIG9uTW91c2VMZWF2ZSgpIHtcclxuICAgICAgICBsZXQgeyBpbnRlcmFjdGl2aXR5IH0gPSB0aGlzLl9wYXJhbXM7XHJcblxyXG4gICAgICAgIGlmIChpbnRlcmFjdGl2aXR5LmV2ZW50cy5vbmhvdmVyLmVuYWJsZSB8fFxyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5LmV2ZW50cy5vbmNsaWNrLmVuYWJsZSkge1xyXG5cclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NfeCA9IG51bGw7XHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UucG9zX3kgPSBudWxsO1xyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5LnN0YXR1cyA9ICdtb3VzZWxlYXZlJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDbGljayBldmVudFxyXG4gICAgICovXHJcbiAgICBASG9zdExpc3RlbmVyKCdjbGljaycpIG9uQ2xpY2soKSB7XHJcbiAgICAgICAgbGV0IHsgaW50ZXJhY3Rpdml0eSwgcGFydGljbGVzIH0gPSB0aGlzLl9wYXJhbXM7XHJcblxyXG4gICAgICAgIGlmIChpbnRlcmFjdGl2aXR5LmV2ZW50cy5vbmNsaWNrLmVuYWJsZSkge1xyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5Lm1vdXNlLmNsaWNrX3Bvc194ID0gaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NfeDtcclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5tb3VzZS5jbGlja19wb3NfeSA9IGludGVyYWN0aXZpdHkubW91c2UucG9zX3k7XHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UuY2xpY2tfdGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xyXG5cclxuICAgICAgICAgICAgc3dpdGNoIChpbnRlcmFjdGl2aXR5LmV2ZW50cy5vbmNsaWNrLm1vZGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3B1c2gnOlxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0aWNsZXMubW92ZS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FudmFzTWFuYWdlci5wYXJ0aWNsZXNNYW5hZ2VyLnB1c2hQYXJ0aWNsZXMoaW50ZXJhY3Rpdml0eS5tb2Rlcy5wdXNoLnBhcnRpY2xlc19uYiwgaW50ZXJhY3Rpdml0eS5tb3VzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGludGVyYWN0aXZpdHkubW9kZXMucHVzaC5wYXJ0aWNsZXNfbmIgPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FudmFzTWFuYWdlci5wYXJ0aWNsZXNNYW5hZ2VyLnB1c2hQYXJ0aWNsZXMoaW50ZXJhY3Rpdml0eS5tb2Rlcy5wdXNoLnBhcnRpY2xlc19uYiwgaW50ZXJhY3Rpdml0eS5tb3VzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW50ZXJhY3Rpdml0eS5tb2Rlcy5wdXNoLnBhcnRpY2xlc19uYiA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NhbnZhc01hbmFnZXIucGFydGljbGVzTWFuYWdlci5wdXNoUGFydGljbGVzKGludGVyYWN0aXZpdHkubW9kZXMucHVzaC5wYXJ0aWNsZXNfbmIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ3JlbW92ZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FudmFzTWFuYWdlci5wYXJ0aWNsZXNNYW5hZ2VyLnJlbW92ZVBhcnRpY2xlcyhpbnRlcmFjdGl2aXR5Lm1vZGVzLnJlbW92ZS5wYXJ0aWNsZXNfbmIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2J1YmJsZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLmJ1YmJsZV9jbGlja2luZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAncmVwdWxzZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLnJlcHVsc2VfY2xpY2tpbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5yZXB1bHNlX2NvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl90bXBQYXJhbXMucmVwdWxzZV9maW5pc2ggPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLnJlcHVsc2VfY2xpY2tpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9LCBpbnRlcmFjdGl2aXR5Lm1vZGVzLnJlcHVsc2UuZHVyYXRpb24gKiAxMDAwKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=