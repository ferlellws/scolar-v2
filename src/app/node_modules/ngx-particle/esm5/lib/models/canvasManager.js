import { ParticlesManager } from './particlesManager';
import { hexToRgb } from './utils';
var CanvasManager = /** @class */ (function () {
    function CanvasManager(_canvasParams, _params, _tmpParams) {
        this._canvasParams = _canvasParams;
        this._params = _params;
        this._tmpParams = _tmpParams;
        this._onWindowResize = this._onWindowResize.bind(this);
        this._retinaInit();
        this._canvasSize();
        this.particlesManager = new ParticlesManager(this._canvasParams, this._params, this._tmpParams);
        this.particlesManager.particlesCreate();
        this._densityAutoParticles();
        var particles = this._params.particles;
        particles.line_linked.color_rgb_line = hexToRgb(particles.line_linked.color);
    }
    CanvasManager.prototype.cancelAnimation = function () {
        if (!this._tmpParams.drawAnimFrame) {
            return;
        }
        cancelAnimationFrame(this._tmpParams.drawAnimFrame);
        this._tmpParams.drawAnimFrame = null;
    };
    CanvasManager.prototype.draw = function () {
        var particles = this._params.particles;
        if (particles.shape.type == 'image') {
            if (this._tmpParams.img_type == 'svg') {
                if (this._tmpParams.count_svg >= particles.number.value) {
                    this.particlesManager.particlesDraw();
                    if (!particles.move.enable) {
                        cancelAnimationFrame(this._tmpParams.drawAnimFrame);
                    }
                    else {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
                else {
                    if (!this._tmpParams.img_error) {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
            }
            else {
                if (this._tmpParams.img_obj != undefined) {
                    this.particlesManager.particlesDraw();
                    if (!particles.move.enable) {
                        cancelAnimationFrame(this._tmpParams.drawAnimFrame);
                    }
                    else {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
                else {
                    if (!this._tmpParams.img_error) {
                        this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
                    }
                }
            }
        }
        else {
            this.particlesManager.particlesDraw();
            if (!particles.move.enable) {
                cancelAnimationFrame(this._tmpParams.drawAnimFrame);
            }
            else {
                this._tmpParams.drawAnimFrame = requestAnimationFrame(this.draw.bind(this));
            }
        }
    };
    CanvasManager.prototype._densityAutoParticles = function () {
        var particles = this._params.particles;
        if (particles.number.density.enable) {
            var area = this._canvasParams.el.width * this._canvasParams.el.height / 1000;
            if (this._tmpParams.retina) {
                area = area / (this._canvasParams.pxratio * 2);
            }
            var nb_particles = area * particles.number.value / particles.number.density.value_area;
            var missing_particles = particles.array.length - nb_particles;
            if (missing_particles < 0) {
                this.particlesManager.pushParticles(Math.abs(missing_particles));
            }
            else {
                this.particlesManager.removeParticles(missing_particles);
            }
        }
    };
    CanvasManager.prototype._retinaInit = function () {
        if (this._params.retina_detect && window.devicePixelRatio > 1) {
            this._canvasParams.pxratio = window.devicePixelRatio;
            this._tmpParams.retina = true;
            this._canvasParams.width = this._canvasParams.el.offsetWidth * this._canvasParams.pxratio;
            this._canvasParams.height = this._canvasParams.el.offsetHeight * this._canvasParams.pxratio;
            this._params.particles.size.value = this._tmpParams.obj.size_value * this._canvasParams.pxratio;
            this._params.particles.size.anim.speed = this._tmpParams.obj.size_anim_speed * this._canvasParams.pxratio;
            this._params.particles.move.speed = this._tmpParams.obj.move_speed * this._canvasParams.pxratio;
            this._params.particles.line_linked.distance = this._tmpParams.obj.line_linked_distance * this._canvasParams.pxratio;
            this._params.interactivity.modes.grab.distance = this._tmpParams.obj.mode_grab_distance * this._canvasParams.pxratio;
            this._params.interactivity.modes.bubble.distance = this._tmpParams.obj.mode_bubble_distance * this._canvasParams.pxratio;
            this._params.particles.line_linked.width = this._tmpParams.obj.line_linked_width * this._canvasParams.pxratio;
            this._params.interactivity.modes.bubble.size = this._tmpParams.obj.mode_bubble_size * this._canvasParams.pxratio;
            this._params.interactivity.modes.repulse.distance = this._tmpParams.obj.mode_repulse_distance * this._canvasParams.pxratio;
        }
        else {
            this._canvasParams.pxratio = 1;
            this._tmpParams.retina = false;
        }
    };
    CanvasManager.prototype._canvasClear = function () {
        this._canvasParams.ctx.clearRect(0, 0, this._canvasParams.width, this._canvasParams.height);
    };
    CanvasManager.prototype._canvasPaint = function () {
        this._canvasParams.ctx.fillRect(0, 0, this._canvasParams.width, this._canvasParams.height);
    };
    CanvasManager.prototype._canvasSize = function () {
        this._canvasParams.el.width = this._canvasParams.width;
        this._canvasParams.el.height = this._canvasParams.height;
        if (this._params && this._params.interactivity.events.resize) {
            window.addEventListener('resize', this._onWindowResize);
        }
    };
    CanvasManager.prototype._onWindowResize = function () {
        this._canvasParams.width = this._canvasParams.el.offsetWidth;
        this._canvasParams.height = this._canvasParams.el.offsetHeight;
        if (this._tmpParams.retina) {
            this._canvasParams.width *= this._canvasParams.pxratio;
            this._canvasParams.height *= this._canvasParams.pxratio;
        }
        this._canvasParams.el.width = this._canvasParams.width;
        this._canvasParams.el.height = this._canvasParams.height;
        if (!this._params.particles.move.enable) {
            this.particlesManager.particlesEmpty();
            this.particlesManager.particlesCreate();
            this.particlesManager.particlesDraw();
            this._densityAutoParticles();
        }
        this._densityAutoParticles();
    };
    return CanvasManager;
}());
export { CanvasManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wYXJ0aWNsZS8iLCJzb3VyY2VzIjpbImxpYi9tb2RlbHMvY2FudmFzTWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV0RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5DO0lBR0ksdUJBQW9CLGFBQTRCLEVBQVUsT0FBZ0IsRUFBVSxVQUFzQjtRQUF0RixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUFVLFlBQU8sR0FBUCxPQUFPLENBQVM7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RHLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVuQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2hHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV4QyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUV2QixJQUFBLGtDQUFTLENBQWtCO1FBQ2pDLFNBQVMsQ0FBQyxXQUFXLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pGLENBQUM7SUFFTSx1Q0FBZSxHQUF0QjtRQUNJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRTtZQUNoQyxPQUFPO1NBQ1Y7UUFDRCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEs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ZXIgfSBmcm9tICcuL3BhcnRpY2xlc01hbmFnZXInO1xyXG5pbXBvcnQgeyBJQ2FudmFzUGFyYW1zLCBJUGFyYW1zLCBJVG1wUGFyYW1zIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcclxuaW1wb3J0IHsgaGV4VG9SZ2IgfSBmcm9tICcuL3V0aWxzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBDYW52YXNNYW5hZ2VyIHtcclxuICAgIHB1YmxpYyBwYXJ0aWNsZXNNYW5hZ2VyOiBQYXJ0aWNsZXNNYW5hZ2VyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NhbnZhc1BhcmFtczogSUNhbnZhc1BhcmFtcywgcHJpdmF0ZSBfcGFyYW1zOiBJUGFyYW1zLCBwcml2YXRlIF90bXBQYXJhbXM6IElUbXBQYXJhbXMpIHtcclxuICAgICAgICB0aGlzLl9vbldpbmRvd1Jlc2l6ZSA9IHRoaXMuX29uV2luZG93UmVzaXplLmJpbmQodGhpcyk7XHJcblxyXG4gICAgICAgIHRoaXMuX3JldGluYUluaXQoKTtcclxuICAgICAgICB0aGlzLl9jYW52YXNTaXplKCk7XHJcblxyXG4gICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlciA9IG5ldyBQYXJ0aWNsZXNNYW5hZ2VyKHRoaXMuX2NhbnZhc1BhcmFtcywgdGhpcy5fcGFyYW1zLCB0aGlzLl90bXBQYXJhbXMpO1xyXG4gICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5wYXJ0aWNsZXNDcmVhdGUoKTtcclxuXHJcbiAgICAgICAgdGhpcy5fZGVuc2l0eUF1dG9QYXJ0aWNsZXMoKTtcclxuXHJcbiAgICAgICAgbGV0IHsgcGFydGljbGVzIH0gPSB0aGlzLl9wYXJhbXM7XHJcbiAgICAgICAgcGFydGljbGVzLmxpbmVfbGlua2VkLmNvbG9yX3JnYl9saW5lID0gaGV4VG9SZ2IocGFydGljbGVzLmxpbmVfbGlua2VkLmNvbG9yKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2FuY2VsQW5pbWF0aW9uKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSk7XHJcbiAgICAgICAgdGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkcmF3KCk6IHZvaWQge1xyXG4gICAgICAgIGxldCB7IHBhcnRpY2xlcyB9ID0gdGhpcy5fcGFyYW1zO1xyXG5cclxuICAgICAgICBpZiAocGFydGljbGVzLnNoYXBlLnR5cGUgPT0gJ2ltYWdlJykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fdG1wUGFyYW1zLmltZ190eXBlID09ICdzdmcnKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdG1wUGFyYW1zLmNvdW50X3N2ZyA+PSBwYXJ0aWNsZXMubnVtYmVyLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnBhcnRpY2xlc0RyYXcoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXBhcnRpY2xlcy5tb3ZlLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5kcmF3LmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl90bXBQYXJhbXMuaW1nX2Vycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZHJhdy5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdG1wUGFyYW1zLmltZ19vYmogIT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnBhcnRpY2xlc0RyYXcoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXBhcnRpY2xlcy5tb3ZlLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl90bXBQYXJhbXMuZHJhd0FuaW1GcmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLmRyYXdBbmltRnJhbWUgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5kcmF3LmJpbmQodGhpcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl90bXBQYXJhbXMuaW1nX2Vycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZHJhdy5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnBhcnRpY2xlc01hbmFnZXIucGFydGljbGVzRHJhdygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFwYXJ0aWNsZXMubW92ZS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5kcmF3QW5pbUZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZHJhdy5iaW5kKHRoaXMpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9kZW5zaXR5QXV0b1BhcnRpY2xlcygpOiB2b2lkIHtcclxuICAgICAgICBsZXQgeyBwYXJ0aWNsZXMgfSA9IHRoaXMuX3BhcmFtcztcclxuXHJcbiAgICAgICAgaWYgKHBhcnRpY2xlcy5udW1iZXIuZGVuc2l0eS5lbmFibGUpIHtcclxuICAgICAgICAgICAgbGV0IGFyZWE6IG51bWJlciA9IHRoaXMuX2NhbnZhc1BhcmFtcy5lbC53aWR0aCAqIHRoaXMuX2NhbnZhc1BhcmFtcy5lbC5oZWlnaHQgLyAxMDAwO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuX3RtcFBhcmFtcy5yZXRpbmEpIHtcclxuICAgICAgICAgICAgICAgIGFyZWEgPSBhcmVhIC8gKHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvICogMik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBuYl9wYXJ0aWNsZXM6IG51bWJlciA9IGFyZWEgKiBwYXJ0aWNsZXMubnVtYmVyLnZhbHVlIC8gcGFydGljbGVzLm51bWJlci5kZW5zaXR5LnZhbHVlX2FyZWE7XHJcblxyXG4gICAgICAgICAgICBsZXQgbWlzc2luZ19wYXJ0aWNsZXM6IG51bWJlciA9IHBhcnRpY2xlcy5hcnJheS5sZW5ndGggLSBuYl9wYXJ0aWNsZXM7XHJcblxyXG4gICAgICAgICAgICBpZiAobWlzc2luZ19wYXJ0aWNsZXMgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhcnRpY2xlc01hbmFnZXIucHVzaFBhcnRpY2xlcyhNYXRoLmFicyhtaXNzaW5nX3BhcnRpY2xlcykpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnJlbW92ZVBhcnRpY2xlcyhtaXNzaW5nX3BhcnRpY2xlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfcmV0aW5hSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5fcGFyYW1zLnJldGluYV9kZXRlY3QgJiYgd2luZG93LmRldmljZVBpeGVsUmF0aW8gPiAxKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvID0gd2luZG93LmRldmljZVBpeGVsUmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5yZXRpbmEgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLndpZHRoID0gdGhpcy5fY2FudmFzUGFyYW1zLmVsLm9mZnNldFdpZHRoICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5oZWlnaHQgPSB0aGlzLl9jYW52YXNQYXJhbXMuZWwub2Zmc2V0SGVpZ2h0ICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucGFydGljbGVzLnNpemUudmFsdWUgPSB0aGlzLl90bXBQYXJhbXMub2JqLnNpemVfdmFsdWUgKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5zaXplLmFuaW0uc3BlZWQgPSB0aGlzLl90bXBQYXJhbXMub2JqLnNpemVfYW5pbV9zcGVlZCAqIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucGFydGljbGVzLm1vdmUuc3BlZWQgPSB0aGlzLl90bXBQYXJhbXMub2JqLm1vdmVfc3BlZWQgKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5saW5lX2xpbmtlZC5kaXN0YW5jZSA9IHRoaXMuX3RtcFBhcmFtcy5vYmoubGluZV9saW5rZWRfZGlzdGFuY2UgKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkubW9kZXMuZ3JhYi5kaXN0YW5jZSA9IHRoaXMuX3RtcFBhcmFtcy5vYmoubW9kZV9ncmFiX2Rpc3RhbmNlICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5pbnRlcmFjdGl2aXR5Lm1vZGVzLmJ1YmJsZS5kaXN0YW5jZSA9IHRoaXMuX3RtcFBhcmFtcy5vYmoubW9kZV9idWJibGVfZGlzdGFuY2UgKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5saW5lX2xpbmtlZC53aWR0aCA9IHRoaXMuX3RtcFBhcmFtcy5vYmoubGluZV9saW5rZWRfd2lkdGggKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkubW9kZXMuYnViYmxlLnNpemUgPSB0aGlzLl90bXBQYXJhbXMub2JqLm1vZGVfYnViYmxlX3NpemUgKiB0aGlzLl9jYW52YXNQYXJhbXMucHhyYXRpbztcclxuICAgICAgICAgICAgdGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkubW9kZXMucmVwdWxzZS5kaXN0YW5jZSA9IHRoaXMuX3RtcFBhcmFtcy5vYmoubW9kZV9yZXB1bHNlX2Rpc3RhbmNlICogdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvID0gMTtcclxuICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLnJldGluYSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jYW52YXNDbGVhcigpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuY3R4LmNsZWFyUmVjdCgwLCAwLCB0aGlzLl9jYW52YXNQYXJhbXMud2lkdGgsIHRoaXMuX2NhbnZhc1BhcmFtcy5oZWlnaHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2NhbnZhc1BhaW50KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5jdHguZmlsbFJlY3QoMCwgMCwgdGhpcy5fY2FudmFzUGFyYW1zLndpZHRoLCB0aGlzLl9jYW52YXNQYXJhbXMuaGVpZ2h0KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jYW52YXNTaXplKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5lbC53aWR0aCA9IHRoaXMuX2NhbnZhc1BhcmFtcy53aWR0aDtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuZWwuaGVpZ2h0ID0gdGhpcy5fY2FudmFzUGFyYW1zLmhlaWdodDtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX3BhcmFtcyAmJiB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5ldmVudHMucmVzaXplKSB7XHJcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl9vbldpbmRvd1Jlc2l6ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX29uV2luZG93UmVzaXplKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy53aWR0aCA9IHRoaXMuX2NhbnZhc1BhcmFtcy5lbC5vZmZzZXRXaWR0aDtcclxuICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuaGVpZ2h0ID0gdGhpcy5fY2FudmFzUGFyYW1zLmVsLm9mZnNldEhlaWdodDtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX3RtcFBhcmFtcy5yZXRpbmEpIHtcclxuICAgICAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLndpZHRoICo9IHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG4gICAgICAgICAgICB0aGlzLl9jYW52YXNQYXJhbXMuaGVpZ2h0ICo9IHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY2FudmFzUGFyYW1zLmVsLndpZHRoID0gdGhpcy5fY2FudmFzUGFyYW1zLndpZHRoO1xyXG4gICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcy5lbC5oZWlnaHQgPSB0aGlzLl9jYW52YXNQYXJhbXMuaGVpZ2h0O1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMubW92ZS5lbmFibGUpIHtcclxuICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnBhcnRpY2xlc0VtcHR5KCk7XHJcbiAgICAgICAgICAgIHRoaXMucGFydGljbGVzTWFuYWdlci5wYXJ0aWNsZXNDcmVhdGUoKTtcclxuICAgICAgICAgICAgdGhpcy5wYXJ0aWNsZXNNYW5hZ2VyLnBhcnRpY2xlc0RyYXcoKTtcclxuICAgICAgICAgICAgdGhpcy5fZGVuc2l0eUF1dG9QYXJ0aWNsZXMoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2RlbnNpdHlBdXRvUGFydGljbGVzKCk7XHJcbiAgICB9XHJcbn1cclxuIl19