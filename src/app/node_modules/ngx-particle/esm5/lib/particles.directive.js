import { __decorate, __metadata } from "tslib";
import { Directive, ElementRef, AfterViewInit, HostListener, Input, OnDestroy } from "@angular/core";
import { CanvasManager, getDefaultParams, isInArray, deepExtend, loadImg } from './models';
var ParticlesDirective = /** @class */ (function () {
    function ParticlesDirective(el) {
        this.el = el;
        this._tmpParams = {};
    }
    Object.defineProperty(ParticlesDirective.prototype, "params", {
        set: function (value) {
            var defaultParams = getDefaultParams();
            this._params = deepExtend(defaultParams, value);
        },
        enumerable: true,
        configurable: true
    });
    ParticlesDirective.prototype.ngOnDestroy = function () {
        if (!this._canvasManager) {
            return;
        }
        this._canvasManager.cancelAnimation();
    };
    ParticlesDirective.prototype.ngAfterViewInit = function () {
        this._canvasParams = {
            el: this.el.nativeElement,
            ctx: this.el.nativeElement.getContext('2d'),
            width: this.el.nativeElement.offsetWidth,
            height: this.el.nativeElement.offsetHeight
        };
        this._tmpParams.obj = {
            size_value: this._params.particles.size.value,
            size_anim_speed: this._params.particles.size.anim.speed,
            move_speed: this._params.particles.move.speed,
            line_linked_distance: this._params.particles.line_linked.distance,
            line_linked_width: this._params.particles.line_linked.width,
            mode_grab_distance: this._params.interactivity.modes.grab.distance,
            mode_bubble_distance: this._params.interactivity.modes.bubble.distance,
            mode_bubble_size: this._params.interactivity.modes.bubble.size,
            mode_repulse_distance: this._params.interactivity.modes.repulse.distance
        };
        this._params.interactivity.el = (this._params.interactivity.detect_on == 'window') ? window : this._canvasParams.el;
        if (isInArray('image', this._params.particles.shape.type)) {
            this._tmpParams.img_type = this._params.particles.shape.image.src.substr(this._params.particles.shape.image.src.length - 3);
            loadImg(this._params, this._tmpParams);
        }
        this._canvasManager = new CanvasManager(this._canvasParams, this._params, this._tmpParams);
        this._canvasManager.draw();
    };
    /**
     * Mouse move event
     * @param event
     */
    ParticlesDirective.prototype.onMouseMove = function (event) {
        var interactivity = this._params.interactivity;
        if (interactivity.events.onhover.enable ||
            interactivity.events.onclick.enable) {
            var pos = void 0;
            if (interactivity.el == window) {
                pos = {
                    x: event.clientX,
                    y: event.clientY
                };
            }
            else {
                pos = {
                    x: event.offsetX || event.clientX,
                    y: event.offsetY || event.clientY
                };
            }
            interactivity.mouse.pos_x = pos.x;
            interactivity.mouse.pos_y = pos.y;
            if (this._tmpParams.retina) {
                interactivity.mouse.pos_x *= this._canvasParams.pxratio;
                interactivity.mouse.pos_y *= this._canvasParams.pxratio;
            }
            interactivity.status = 'mousemove';
        }
    };
    /**
     * Mouse leave event
     */
    ParticlesDirective.prototype.onMouseLeave = function () {
        var interactivity = this._params.interactivity;
        if (interactivity.events.onhover.enable ||
            interactivity.events.onclick.enable) {
            interactivity.mouse.pos_x = null;
            interactivity.mouse.pos_y = null;
            interactivity.status = 'mouseleave';
        }
    };
    /**
     * Click event
     */
    ParticlesDirective.prototype.onClick = function () {
        var _this = this;
        var _a = this._params, interactivity = _a.interactivity, particles = _a.particles;
        if (interactivity.events.onclick.enable) {
            interactivity.mouse.click_pos_x = interactivity.mouse.pos_x;
            interactivity.mouse.click_pos_y = interactivity.mouse.pos_y;
            interactivity.mouse.click_time = new Date().getTime();
            switch (interactivity.events.onclick.mode) {
                case 'push':
                    if (particles.move.enable) {
                        this._canvasManager.particlesManager.pushParticles(interactivity.modes.push.particles_nb, interactivity.mouse);
                    }
                    else {
                        if (interactivity.modes.push.particles_nb == 1) {
                            this._canvasManager.particlesManager.pushParticles(interactivity.modes.push.particles_nb, interactivity.mouse);
                        }
                        else if (interactivity.modes.push.particles_nb > 1) {
                            this._canvasManager.particlesManager.pushParticles(interactivity.modes.push.particles_nb);
                        }
                    }
                    break;
                case 'remove':
                    this._canvasManager.particlesManager.removeParticles(interactivity.modes.remove.particles_nb);
                    break;
                case 'bubble':
                    this._tmpParams.bubble_clicking = true;
                    break;
                case 'repulse':
                    this._tmpParams.repulse_clicking = true;
                    this._tmpParams.repulse_count = 0;
                    this._tmpParams.repulse_finish = false;
                    setTimeout(function () {
                        _this._tmpParams.repulse_clicking = false;
                    }, interactivity.modes.repulse.duration * 1000);
                    break;
            }
        }
    };
    ParticlesDirective.ctorParameters = function () { return [
        { type: ElementRef }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], ParticlesDirective.prototype, "params", null);
    __decorate([
        HostListener('mousemove', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Object]),
        __metadata("design:returntype", void 0)
    ], ParticlesDirective.prototype, "onMouseMove", null);
    __decorate([
        HostListener('mouseleave'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], ParticlesDirective.prototype, "onMouseLeave", null);
    __decorate([
        HostListener('click'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], ParticlesDirective.prototype, "onClick", null);
    ParticlesDirective = __decorate([
        Directive({
            selector: '[d-particles]'
        }),
        __metadata("design:paramtypes", [ElementRef])
    ], ParticlesDirective);
    return ParticlesDirective;
}());
export { ParticlesDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGljbGVzLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1wYXJ0aWNsZS8iLCJzb3VyY2VzIjpbImxpYi9wYXJ0aWNsZXMuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckcsT0FBTyxFQUFFLGFBQWEsRUFBc0MsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFLL0g7SUFNSSw0QkFBb0IsRUFBYztRQUFkLE9BQUUsR0FBRixFQUFFLENBQVk7UUFJMUIsZUFBVSxHQUFlLEVBQUUsQ0FBQztJQUpFLENBQUM7SUFMOUIsc0JBQUksc0NBQU07YUFBVixVQUFXLEtBQWM7WUFDOUIsSUFBSSxhQUFhLEdBQVksZ0JBQWdCLEVBQUUsQ0FBQztZQUNoRCxJQUFJLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEQsQ0FBQzs7O09BQUE7SUFTRCx3Q0FBVyxHQUFYO1FBQ0ksSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDdEIsT0FBTztTQUNWO1FBQ0QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBRUQsNENBQWUsR0FBZjtRQUNJLElBQUksQ0FBQyxhQUFhLEdBQUc7WUFDakIsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYTtZQUN6QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztZQUMzQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsV0FBVztZQUN4QyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUs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QUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztvQkFDeEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO29CQUNsQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7b0JBQ3ZDLFVBQVUsQ0FBQzt3QkFDUCxLQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztvQkFDN0MsQ0FBQyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQztvQkFDaEQsTUFBTTthQUNiO1NBQ0o7SUFDTCxDQUFDOztnQkE3SXVCLFVBQVU7O0lBTHpCO1FBQVIsS0FBSyxFQUFFOzs7b0RBR1A7SUFtRHNDO1FBQXRDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7Ozt5REFpQ3JDO0lBSzJCO1FBQTNCLFlBQVksQ0FBQyxZQUFZLENBQUM7Ozs7MERBVTFCO0lBS3NCO1FBQXRCLFlBQVksQ0FBQyxPQUFPLENBQUM7Ozs7cURBdUNyQjtJQW5KUSxrQkFBa0I7UUFIOUIsU0FBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLGVBQWU7U0FDNUIsQ0FBQzt5Q0FPMEIsVUFBVTtPQU56QixrQkFBa0IsQ0FvSjlCO0lBQUQseUJBQUM7Q0FBQSxBQXBKRCxJQW9KQztTQXBKWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEFmdGVyVmlld0luaXQsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE9uRGVzdHJveSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IENhbnZhc01hbmFnZXIsIElDYW52YXNQYXJhbXMsIElQYXJhbXMsIElUbXBQYXJhbXMsIGdldERlZmF1bHRQYXJhbXMsIGlzSW5BcnJheSwgZGVlcEV4dGVuZCwgbG9hZEltZyB9IGZyb20gJy4vbW9kZWxzJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbZC1wYXJ0aWNsZXNdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUGFydGljbGVzRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95ICB7XHJcbiAgICBASW5wdXQoKSBzZXQgcGFyYW1zKHZhbHVlOiBJUGFyYW1zKSB7XHJcbiAgICAgICAgbGV0IGRlZmF1bHRQYXJhbXM6IElQYXJhbXMgPSBnZXREZWZhdWx0UGFyYW1zKCk7XHJcbiAgICAgICAgdGhpcy5fcGFyYW1zID0gZGVlcEV4dGVuZChkZWZhdWx0UGFyYW1zLCB2YWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBlbDogRWxlbWVudFJlZikgeyB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY2FudmFzUGFyYW1zOiBJQ2FudmFzUGFyYW1zO1xyXG4gICAgcHJpdmF0ZSBfcGFyYW1zOiBJUGFyYW1zO1xyXG4gICAgcHJpdmF0ZSBfdG1wUGFyYW1zOiBJVG1wUGFyYW1zID0ge307XHJcbiAgICBwcml2YXRlIF9jYW52YXNNYW5hZ2VyOiBDYW52YXNNYW5hZ2VyO1xyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5fY2FudmFzTWFuYWdlcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2NhbnZhc01hbmFnZXIuY2FuY2VsQW5pbWF0aW9uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2NhbnZhc1BhcmFtcyA9IHtcclxuICAgICAgICAgICAgZWw6IHRoaXMuZWwubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgY3R4OiB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKSxcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMuZWwubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5fdG1wUGFyYW1zLm9iaiA9IHtcclxuICAgICAgICAgICAgc2l6ZV92YWx1ZTogdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5zaXplLnZhbHVlLFxyXG4gICAgICAgICAgICBzaXplX2FuaW1fc3BlZWQ6IHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMuc2l6ZS5hbmltLnNwZWVkLFxyXG4gICAgICAgICAgICBtb3ZlX3NwZWVkOiB0aGlzLl9wYXJhbXMucGFydGljbGVzLm1vdmUuc3BlZWQsXHJcbiAgICAgICAgICAgIGxpbmVfbGlua2VkX2Rpc3RhbmNlOiB0aGlzLl9wYXJhbXMucGFydGljbGVzLmxpbmVfbGlua2VkLmRpc3RhbmNlLFxyXG4gICAgICAgICAgICBsaW5lX2xpbmtlZF93aWR0aDogdGhpcy5fcGFyYW1zLnBhcnRpY2xlcy5saW5lX2xpbmtlZC53aWR0aCxcclxuICAgICAgICAgICAgbW9kZV9ncmFiX2Rpc3RhbmNlOiB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5tb2Rlcy5ncmFiLmRpc3RhbmNlLFxyXG4gICAgICAgICAgICBtb2RlX2J1YmJsZV9kaXN0YW5jZTogdGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkubW9kZXMuYnViYmxlLmRpc3RhbmNlLFxyXG4gICAgICAgICAgICBtb2RlX2J1YmJsZV9zaXplOiB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5tb2Rlcy5idWJibGUuc2l6ZSxcclxuICAgICAgICAgICAgbW9kZV9yZXB1bHNlX2Rpc3RhbmNlOiB0aGlzLl9wYXJhbXMuaW50ZXJhY3Rpdml0eS5tb2Rlcy5yZXB1bHNlLmRpc3RhbmNlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkuZWwgPSAodGhpcy5fcGFyYW1zLmludGVyYWN0aXZpdHkuZGV0ZWN0X29uID09ICd3aW5kb3cnKSA/IHdpbmRvdyA6IHRoaXMuX2NhbnZhc1BhcmFtcy5lbDtcclxuXHJcbiAgICAgICAgaWYgKGlzSW5BcnJheSgnaW1hZ2UnLCB0aGlzLl9wYXJhbXMucGFydGljbGVzLnNoYXBlLnR5cGUpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5pbWdfdHlwZSA9IHRoaXMuX3BhcmFtcy5wYXJ0aWNsZXMuc2hhcGUuaW1hZ2Uuc3JjLnN1YnN0cih0aGlzLl9wYXJhbXMucGFydGljbGVzLnNoYXBlLmltYWdlLnNyYy5sZW5ndGggLSAzKTtcclxuICAgICAgICAgICAgbG9hZEltZyh0aGlzLl9wYXJhbXMsIHRoaXMuX3RtcFBhcmFtcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9jYW52YXNNYW5hZ2VyID0gbmV3IENhbnZhc01hbmFnZXIodGhpcy5fY2FudmFzUGFyYW1zLCB0aGlzLl9wYXJhbXMsIHRoaXMuX3RtcFBhcmFtcyk7XHJcbiAgICAgICAgdGhpcy5fY2FudmFzTWFuYWdlci5kcmF3KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBNb3VzZSBtb3ZlIGV2ZW50XHJcbiAgICAgKiBAcGFyYW0gZXZlbnRcclxuICAgICAqL1xyXG4gICAgQEhvc3RMaXN0ZW5lcignbW91c2Vtb3ZlJywgWyckZXZlbnQnXSkgb25Nb3VzZU1vdmUoZXZlbnQpIHtcclxuICAgICAgICBsZXQgeyBpbnRlcmFjdGl2aXR5IH0gPSB0aGlzLl9wYXJhbXM7XHJcblxyXG4gICAgICAgIGlmIChpbnRlcmFjdGl2aXR5LmV2ZW50cy5vbmhvdmVyLmVuYWJsZSB8fFxyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5LmV2ZW50cy5vbmNsaWNrLmVuYWJsZSkge1xyXG5cclxuICAgICAgICAgICAgbGV0IHBvczoge1xyXG4gICAgICAgICAgICAgICAgeDogbnVtYmVyO1xyXG4gICAgICAgICAgICAgICAgeTogbnVtYmVyO1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgaWYgKGludGVyYWN0aXZpdHkuZWwgPT0gd2luZG93KSB7XHJcbiAgICAgICAgICAgICAgICBwb3MgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgeDogZXZlbnQuY2xpZW50WCxcclxuICAgICAgICAgICAgICAgICAgICB5OiBldmVudC5jbGllbnRZXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcG9zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHg6IGV2ZW50Lm9mZnNldFggfHwgZXZlbnQuY2xpZW50WCxcclxuICAgICAgICAgICAgICAgICAgICB5OiBldmVudC5vZmZzZXRZIHx8IGV2ZW50LmNsaWVudFlcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UucG9zX3ggPSBwb3MueDtcclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5tb3VzZS5wb3NfeSA9IHBvcy55O1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuX3RtcFBhcmFtcy5yZXRpbmEpIHtcclxuICAgICAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UucG9zX3ggKj0gdGhpcy5fY2FudmFzUGFyYW1zLnB4cmF0aW87XHJcbiAgICAgICAgICAgICAgICBpbnRlcmFjdGl2aXR5Lm1vdXNlLnBvc195ICo9IHRoaXMuX2NhbnZhc1BhcmFtcy5weHJhdGlvO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5LnN0YXR1cyA9ICdtb3VzZW1vdmUnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIE1vdXNlIGxlYXZlIGV2ZW50XHJcbiAgICAgKi9cclxuICAgIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnKSBvbk1vdXNlTGVhdmUoKSB7XHJcbiAgICAgICAgbGV0IHsgaW50ZXJhY3Rpdml0eSB9ID0gdGhpcy5fcGFyYW1zO1xyXG5cclxuICAgICAgICBpZiAoaW50ZXJhY3Rpdml0eS5ldmVudHMub25ob3Zlci5lbmFibGUgfHxcclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5ldmVudHMub25jbGljay5lbmFibGUpIHtcclxuXHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UucG9zX3ggPSBudWxsO1xyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5Lm1vdXNlLnBvc195ID0gbnVsbDtcclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5zdGF0dXMgPSAnbW91c2VsZWF2ZSc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2xpY2sgZXZlbnRcclxuICAgICAqL1xyXG4gICAgQEhvc3RMaXN0ZW5lcignY2xpY2snKSBvbkNsaWNrKCkge1xyXG4gICAgICAgIGxldCB7IGludGVyYWN0aXZpdHksIHBhcnRpY2xlcyB9ID0gdGhpcy5fcGFyYW1zO1xyXG5cclxuICAgICAgICBpZiAoaW50ZXJhY3Rpdml0eS5ldmVudHMub25jbGljay5lbmFibGUpIHtcclxuICAgICAgICAgICAgaW50ZXJhY3Rpdml0eS5tb3VzZS5jbGlja19wb3NfeCA9IGludGVyYWN0aXZpdHkubW91c2UucG9zX3g7XHJcbiAgICAgICAgICAgIGludGVyYWN0aXZpdHkubW91c2UuY2xpY2tfcG9zX3kgPSBpbnRlcmFjdGl2aXR5Lm1vdXNlLnBvc195O1xyXG4gICAgICAgICAgICBpbnRlcmFjdGl2aXR5Lm1vdXNlLmNsaWNrX3RpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoaW50ZXJhY3Rpdml0eS5ldmVudHMub25jbGljay5tb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdwdXNoJzpcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGFydGljbGVzLm1vdmUuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NhbnZhc01hbmFnZXIucGFydGljbGVzTWFuYWdlci5wdXNoUGFydGljbGVzKGludGVyYWN0aXZpdHkubW9kZXMucHVzaC5wYXJ0aWNsZXNfbmIsIGludGVyYWN0aXZpdHkubW91c2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcmFjdGl2aXR5Lm1vZGVzLnB1c2gucGFydGljbGVzX25iID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NhbnZhc01hbmFnZXIucGFydGljbGVzTWFuYWdlci5wdXNoUGFydGljbGVzKGludGVyYWN0aXZpdHkubW9kZXMucHVzaC5wYXJ0aWNsZXNfbmIsIGludGVyYWN0aXZpdHkubW91c2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGludGVyYWN0aXZpdHkubW9kZXMucHVzaC5wYXJ0aWNsZXNfbmIgPiAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jYW52YXNNYW5hZ2VyLnBhcnRpY2xlc01hbmFnZXIucHVzaFBhcnRpY2xlcyhpbnRlcmFjdGl2aXR5Lm1vZGVzLnB1c2gucGFydGljbGVzX25iKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdyZW1vdmUnOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2NhbnZhc01hbmFnZXIucGFydGljbGVzTWFuYWdlci5yZW1vdmVQYXJ0aWNsZXMoaW50ZXJhY3Rpdml0eS5tb2Rlcy5yZW1vdmUucGFydGljbGVzX25iKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdidWJibGUnOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5idWJibGVfY2xpY2tpbmcgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ3JlcHVsc2UnOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5yZXB1bHNlX2NsaWNraW5nID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl90bXBQYXJhbXMucmVwdWxzZV9jb3VudCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG1wUGFyYW1zLnJlcHVsc2VfZmluaXNoID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RtcFBhcmFtcy5yZXB1bHNlX2NsaWNraW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgaW50ZXJhY3Rpdml0eS5tb2Rlcy5yZXB1bHNlLmR1cmF0aW9uICogMTAwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19